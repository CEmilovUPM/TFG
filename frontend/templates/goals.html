{% extends "base.html" %}

{% block title %}Your Goals{% endblock %}

{% block content %}
  {% if isAdmin %}
    <div class="back-button-container">
      <a href="{{ url_for('protected.admin_dashboard') }}" class="go-back-button">‚Üê Go Back</a>
    </div>
  {% endif %}

  <div class="top-actions">
    <a href="{{ url_for('protected.create_goal_form', user_id=user_id) }}" class="new-goal-button">‚ûï New Goal</a>
  </div>

  <form method="get" action="{{ url_for('protected.goals_list', user_id=user_id) }}" class="goal-search-form">
    <input type="text" name="q" placeholder="Search goals..." value="{{ request.args.get('q', '') }}" />
    <button type="submit">Search</button>
  </form>

  {% if goals %}
    {% for goal in goals %}
      <div class="goal-container">
        <a href="/user/{{ user_id }}/goals/{{ goal.id }}" class="goal-link">
          <div class="goal-info">
            <h2>{{ goal.title }}</h2>
            <p>{{ goal.description }}</p>
            <p>Goal: {{ goal.totalDesiredAmount | trim_float }} [{{ goal.metric }}]</p>
          </div>
        </a>
        <button class="delete-button" data-goal-id="{{ goal.id }}" title="Delete Goal">
          üóëÔ∏è
        </button>
      </div>
    {% endfor %}
  {% else %}
    <p>No goals found.</p>
  {% endif %}

  <script>
    document.querySelectorAll('.delete-button').forEach(button => {
      button.addEventListener('click', async e => {
        e.preventDefault();
        const goalId = button.getAttribute('data-goal-id');
        const confirmDelete = confirm("Are you sure you want to delete this goal?");
        if (!confirmDelete) return;

        try {
          const userId = {{ user_id }};
          const res = await fetch(`/api/user/${userId}/goal/${goalId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
            }
          });

          if (res.status === 204) {
            window.location.reload();
          } else {
            const data = await res.json();
            alert(data.message || "Failed to delete goal.");
          }
        } catch (err) {
          console.error("Delete failed:", err);
          alert("Error occurred while deleting.");
        }
      });
    });
  </script>

  <style>
    .back-button-container {
      display: flex;
      justify-content: flex-start;
      margin-bottom: 10px;
    }
    .go-back-button {
      background-color: #6c757d;
      color: white;
      padding: 8px 14px;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
    }
    .go-back-button:hover {
      background-color: #5a6268;
    }
    .top-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    .new-goal-button {
      background-color: #28a745;
      color: white;
      padding: 8px 14px;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
    }
    .new-goal-button:hover {
      background-color: #218838;
    }
    .delete-button {
      background: none;
      border: none;
      color: red;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    .goal-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    .goal-link {
      flex-grow: 1;
      text-decoration: none;
      color: inherit;
    }
  </style>
{% endblock %}
