<!-- goal.html -->
{% extends "base.html" %}

{% block subtitle %}
  {% if target_name or target_email %}
    <div class="subtitle mb-3">
      Viewing
      {% if target_name %}{{ target_name }}{% endif %}
      {% if target_name and target_email %}, {% endif %}
      {% if target_email %}{{ target_email }}{% endif %}
    </div>
  {% endif %}
{% endblock %}

{% block content %}
<div class="container">
  <a href="{{ url_for('protected.goals_list', user_id=user_id) }}" class="btn btn-secondary mb-3">
    ‚Üê Go Back
  </a>

  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">{{ goal.title }}</h5>
      <div>
        <a href="{{ url_for('protected.update_goal_form', user_id=user_id, goal_id=goal.id) }}" 
           class="btn btn-sm btn-outline-primary me-1">
          ‚úèÔ∏è Update
        </a>
        <button class="btn btn-sm btn-outline-danger delete-button" 
                data-goal-id="{{ goal.id }}" 
                title="Delete Goal">
          üóëÔ∏è Delete
        </button>
      </div>
    </div>
    <div class="card-body">
      <p><strong>Description:</strong> {{ goal.description }}</p>
      <p><strong>Target:</strong> {{ goal.totalDesiredAmount | trim_float }} [{{ goal.metric }}]</p>
      <p><strong>Progress:</strong> {{ progress_amount | trim_float }} [{{ goal.metric }}]</p>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Progress Entries</h4>
    <a href="{{ url_for('protected.create_progress', user_id=user_id, goal_id=goal.id) }}" 
       class="btn btn-success">
      ‚ûï Add Progress
    </a>
  </div>

  <!-- Search Form -->
  <form method="get" action="{{ url_for('protected.single_goal', user_id=user_id, goal_id=goal.id) }}" class="mb-3">
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Search progress..." value="{{ request.args.get('q', '') }}">
      <button class="btn btn-primary" type="submit">Search</button>
    </div>
  </form>

  {% if progress_list %}
    <div class="list-group">
      {% for progress in progress_list %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Date:</strong> {{ progress.date }}
            <div>
              <a href="{{ url_for('protected.update_progress_form', user_id=user_id, goal_id=goal.id, progress_id=progress.id) }}" 
                 class="btn btn-sm btn-outline-primary me-1" title="Edit Progress">
                ‚úèÔ∏è Edit
              </a>
              <button class="btn btn-sm btn-outline-danger progress-delete-button" 
                      data-goal-id="{{ goal.id }}" 
                      data-progress-id="{{ progress.id }}" 
                      title="Delete Progress">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
          <p class="mb-1"><strong>Amount:</strong> {{ progress.amount | trim_float }}</p>
          <p class="mb-0"><strong>Notes:</strong> {{ progress.updateNote }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">No progress entries available</div>
  {% endif %}
</div>

<script>
  document.querySelector('.delete-button').addEventListener('click', async function (e) {
    e.preventDefault();
    const goalId = this.getAttribute('data-goal-id');
    const confirmDelete = confirm("Are you sure you want to delete this goal?");
    if (!confirmDelete) return;

    const userId = {{ user_id }};
    try {
      const res = await fetch(`/api/user/${userId}/goal/${goalId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
        }
      });

      if (res.status === 204) {
        window.location.href = `/user/${userId}/goals`;
      } else {
        const data = await res.json();
        alert(data.message || "Failed to delete goal.");
      }
    } catch (err) {
      console.error("Delete failed:", err);
      alert("Error occurred while deleting.");
    }
  });
</script>
<script>
document.querySelectorAll('.progress-delete-button').forEach(button => {
  button.addEventListener('click', async function (e) {
    e.preventDefault();
    const goalId = this.getAttribute('data-goal-id');
    const progressId = this.getAttribute('data-progress-id');
    const confirmDelete = confirm("Delete this progress entry?");
    if (!confirmDelete) return;

    try {
      const userId = {{ user_id }};
      const res = await fetch(`/api/user/${userId}/goal/${goalId}/progress/${progressId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
        }
      });

      if (res.status === 204) {
        window.location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to delete progress.");
      }
    } catch (err) {
      console.error("Delete failed:", err);
      alert("Error occurred while deleting progress.");
    }
  });
});
</script>
{% endblock %}