{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
  <form method="get" action="{{ url_for('protected.admin_dashboard') }}" class="goal-search-form">
    <input type="text" name="q" placeholder="Search users..." value="{{ request.args.get('q', '') }}" />
    <button type="submit">Search</button>
  </form>

  {% if users %}
    {% for user in users %}
      <div class="goal-container">
        <a href="{{ url_for('protected.goals_list', user_id=user.id) }}" class="goal-link">
          <div class="goal-info">
            <h2>{{ user.name }} {% if user.admin %}(Admin){% endif %}</h2>
            <p>{{ user.email }}</p>
            <p>User ID: {{ user.id }}</p>
          </div>
        </a>
        <div class="admin-actions">
          <button class="action-button ban-toggle" data-user-id="{{ user.email }}" data-action="{{ 'unban' if user.banned else 'ban' }}">
            {{ 'Unban' if user.banned else 'Ban' }}
          </button>
          <button class="action-button promote-toggle" data-user-id="{{ user.email }}" data-action="{{ 'demote' if user.admin else 'promote' }}">
            {{ 'Demote' if user.admin else 'Promote' }}
          </button>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No users found.</p>
  {% endif %}

<script>
  function handleAction(buttonClass, confirmMessageBase) {
    document.querySelectorAll(buttonClass).forEach(button => {
      button.addEventListener('click', async e => {
        e.preventDefault();
        const userId = button.getAttribute('data-user-id');
        const action = button.getAttribute('data-action');
        const confirmMsg = `${confirmMessageBase} this user?`;
        if (!confirm(confirmMsg)) return;

        try {
          const res = await fetch(`/api/admin/user/${userId}/${action}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
            }
          });

          const data = await res.json();

          if (res.ok) {
            alert(data?.info?.[0]?.message || "Action completed successfully.");
            window.location.reload();
          } else {
            const msg =
              data?.error?.[0]?.message ||
              data?.warning?.[0]?.message ||
              "Action failed. Please try again.";
            alert(msg);
          }
        } catch (err) {
          console.error("Request failed:", err);
          alert("Unexpected error occurred while performing action.");
        }
      });
    });
  }

  handleAction('.ban-toggle', 'Are you sure you want to perform this action');
  handleAction('.promote-toggle', 're you sure you want to perform this action');
</script>

  <style>
    .goal-search-form {
      margin: 15px 0;
      display: flex;
      gap: 10px;
    }

    .goal-search-form input {
      flex: 1;
      padding: 6px;
    }

    .goal-search-form button {
      padding: 6px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .goal-search-form button:hover {
      background-color: #0056b3;
    }

    .goal-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }

    .goal-link {
      flex-grow: 1;
      text-decoration: none;
      color: inherit;
    }

    .goal-info h2 {
      margin: 0 0 5px;
    }

    .goal-info p {
      margin: 2px 0;
      font-size: 0.95rem;
    }

    .admin-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .action-button {
      padding: 5px 10px;
      font-size: 0.85rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
    }

    .ban-toggle {
      background-color: #dc3545;
    }

    .ban-toggle:hover {
      background-color: #c82333;
    }

    .promote-toggle {
      background-color: #28a745;
    }

    .promote-toggle:hover {
      background-color: #218838;
    }
  </style>
{% endblock %}
